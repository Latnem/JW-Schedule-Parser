<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Midweek Schedule Fetcher (ASL)</title>
  <style>
    :root {
      --bg: #ffffff; --card: #f7f7f8; --ink: #111; --muted: #666;
      --accent: #4b5563; --shadow: 0 10px 30px rgba(0,0,0,0.06); --radius: 16px;
    }
    body { margin: 0; padding: 24px; font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--ink); }
    .container { max-width: 1100px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; flex-wrap: wrap; gap: 8px; }
    h1 { font-size: 20px; font-weight: 700; margin: 0; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 980px) { .row { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; }
    .controls { display: grid; gap: 12px; }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="url"], input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #ddd; }
    .btns { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    button { border: 0; border-radius: 999px; padding: 10px 14px; cursor: pointer; font-weight: 600; box-shadow: var(--shadow); }
    .primary { background: #4470AD; color: #fff; }  /* Load */
    .ghost { background: #fff; color: var(--ink); border: 1px solid #ddd; }
    .warn { background: #b7791f; color: #fff; }    /* Test */
    .teal { background: #0f766e; color: #fff; }    /* Open */
    .emerald { background: #059669; color: #fff; } /* Parse */
    .status { font-size: 13px; color: #999; min-height: 1.2em; margin-left: 8px; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); margin-top: 8px; }
    .tile { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px; }
    .tile h3 { font-size: 15px; margin: 0 0 6px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
    .strip { height: 6px; background: var(--accent); border-radius: 6px; margin-bottom: 8px; }
    .section { border-left: 4px solid #e5e7eb; padding-left: 10px; margin: 8px 0; }
    .section h4 { margin: 0 0 4px; font-size: 14px; }
    .muted { color: var(--muted); }
    .sec-min { font-size: 12px; color: var(--muted); margin-left: 6px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; background: #f3f4f6; color: #555; padding: 4px 12px; border-radius: 999px; font-size: 13px; font-weight: 500; }
    .pill svg { width: 14px; height: 14px; }
    .week-head { display:flex; align-items:center; justify-content:space-between; gap:8px; position:relative; z-index:2; }
    .iconbtn { display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; border-radius:999px; background:#fff; border:1px solid #e5e7eb; box-shadow: var(--shadow); cursor:pointer; }
    .iconbtn svg { width:100%; height:100%; stroke:#374151; }
    .iconbtn:active { transform: translateY(1px); }
    .italic { font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Midweek Schedule Fetcher (ASL)</h1>
      <div class="pill">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Version: 1.0 (2025-09-24)
      </div>
      <div class="btns"><button class="ghost" id="btnBack" style="display:none">Back</button></div>
    </header>

    <div class="row" id="front">
      <div class="card">
        <div class="strip"></div>
        <div class="controls">
          <div>
            <label>Cloudflare Worker base URL</label>
            <input type="text" id="workerBase" value="https://lmm-tues.latnem.workers.dev/" />
            <div class="btns">
              <button class="warn" id="btnTestWorker">Test</button>
              <span class="status" id="workerStatus"></span>
            </div>
          </div>
          <div>
            <label>LMM Workbook URL</label>
            <input type="url" id="mainUrl" value="https://www.jw.org/ase/library/jw-meeting-workbook/" />
            <div class="btns">
              <button class="primary" id="btnLoadMonths">Load</button>
              <span class="status" id="monthsStatus"></span>
            </div>
            <div class="grid" id="monthsGrid"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="strip"></div>
        <h3>Output</h3>
        <div class="grid" id="weeksGrid" style="margin-bottom:8px;"></div>
        <div class="btns" style="margin-bottom:8px">
          <button class="ghost" id="btnCopyAll">JSON</button>
          <button class="ghost" id="btnClear">Clear</button>
          <span class="status" id="weeksStatus"></span>
        </div>
        <pre class="mono" id="out" style="min-height:160px;"></pre>
      </div>
    </div>

    <div class="card" id="detail" style="display:none">
      <div class="strip"></div>
      <div class="week-head">
        <h3 id="weekTitle">Week</h3>
        <button class="iconbtn" id="btnCopyPreview" title="Copy schedule" style="display:none"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2m2-2h4a2 2 0 012 2v0a2 2 0 01-2 2h-4a2 2 0 01-2-2v0a2 2 0 012-2z"/></svg></button>
      </div>
      <div id="weekView"></div>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const monthsGrid=$("#monthsGrid"), weeksGrid=$("#weeksGrid");
const monthsStatus=$("#monthsStatus"), weeksStatus=$("#weeksStatus"), workerStatus=$("#workerStatus");
const out=$("#out"), weekView=$("#weekView"), btnBack=$("#btnBack");
const btnCopyPreview = $("#btnCopyPreview");

let latestSongs=null, lastResult=null;

$("#btnClear").onclick=()=>{ out.textContent=""; weekView.innerHTML=""; weeksStatus.textContent=""; latestSongs=null; lastResult=null; btnCopyPreview.style.display="none"; };

$("#btnCopyAll").onclick=async()=>{
  if(!lastResult){ weeksStatus.textContent="Nothing to copy."; return; }
  try{ await navigator.clipboard.writeText(JSON.stringify(lastResult, null, 2)); weeksStatus.textContent="Copied JSON."; }
  catch{ weeksStatus.textContent="Copy failed."; }
};

btnCopyPreview.addEventListener('click', async (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  const wtEl = document.querySelector('#weekTitle');
  const wt = wtEl ? wtEl.textContent : 'Week';
  const res = lastResult;
  if(!res){ weeksStatus.textContent='Nothing parsed yet.'; return; }
  const text = buildScheduleText(wt, res);
  const ok = await copyText(text);
  weeksStatus.textContent = ok ? 'Copied schedule.' : 'Copy failed.';
});

btnBack.onclick=()=>{ $("#detail").style.display="none"; $("#front").style.display=""; btnBack.style.display="none"; };

/* ----------------- Test worker (health) ----------------- */
$("#btnTestWorker").onclick=async()=>{
  const worker=$("#workerBase").value.trim();
  if(!worker){ workerStatus.textContent="Enter Worker URL"; return; }
  workerStatus.textContent="Pinging…";
  try{
    const healthUrl = worker.replace(/\/+$/,"")+"/api/health";
    const res = await fetch(healthUrl, {method:"GET"});
    await res.text();
    workerStatus.textContent = res.ok? "Health OK ("+res.status+")" : "Health failed ("+res.status+")";
  }catch(e){ console.error(e); workerStatus.textContent = "Ping error"; }
};

/* ----------------- Load months via Worker ----------------- */
$("#btnLoadMonths").onclick=async()=>{
  const worker=$("#workerBase").value.trim(), main=$("#mainUrl").value.trim();
  if(!worker||!main){ monthsStatus.textContent="Missing input"; return; }
  monthsStatus.textContent="Loading months…"; monthsGrid.innerHTML=""; weeksGrid.innerHTML=""; weeksStatus.textContent="";
  try{
    const endpoint = worker.replace(/\/+$/,"")+"/api/listMonths?u="+encodeURIComponent(main);
    const resp = await fetch(endpoint);
    if(!resp.ok){ throw new Error("listMonths "+resp.status); }
    const data = await resp.json();
    const items = (data.months||[]);
    if(!items.length){ monthsStatus.textContent="No months found"; return; }
    monthsStatus.textContent = items.length+" months found";
    renderMonths(items);
  }catch(e){ console.error(e); monthsStatus.textContent="Load failed"; }
};

function renderMonths(items){
  monthsGrid.innerHTML="";
  for(const it of items){
    const tile=document.createElement("div");
    tile.className="tile";
    tile.innerHTML=`<h3>${escapeHtml(it.title)}</h3><div class="btns"><button class="teal">Open</button></div>`;
    tile.querySelector("button").onclick=()=>loadWeeks(it.url, it.title);
    monthsGrid.appendChild(tile);
  }
}

/* ----------------- Load weeks via Worker ----------------- */
async function loadWeeks(monthUrl, title){
  weeksStatus.textContent=`Loading weeks…`; weeksGrid.innerHTML="";
  try{
    const worker=$("#workerBase").value.trim();
    const endpoint = worker.replace(/\/+$/,"")+"/api/listWeeks?u="+encodeURIComponent(monthUrl);
    const resp = await fetch(endpoint);
    if(!resp.ok){ throw new Error("listWeeks "+resp.status); }
    const data = await resp.json();
    const items = data.weeks || [];
    if(!items.length){ weeksStatus.textContent="No weeks found"; return; }
    weeksStatus.textContent = items.length+" weeks found";
    renderWeeks(items);
  }catch(e){ console.error(e); weeksStatus.textContent="Load failed"; }
}

function renderWeeks(items){
  weeksGrid.innerHTML="";
  for(const it of items){
    const tile=document.createElement("div");
    tile.className="tile";
    tile.innerHTML=`<h3>${escapeHtml(it.title)}</h3>
    <div class="btns"><button class="emerald">Parse</button></div>`;
    tile.querySelector("button").onclick=()=>parseWeek(it.url, it.title);
    weeksGrid.appendChild(tile);
  }
}

/* ----------------- Parse week via Worker ----------------- */
async function parseWeek(weekUrl, weekLabel){
  weeksStatus.textContent="Loading week…";
  out.textContent=""; weekView.innerHTML=""; latestSongs=null; lastResult=null;
  const wt=document.querySelector('#weekTitle'); if(wt) wt.textContent = weekLabel || 'Week';
  try{
    const worker=$("#workerBase").value.trim();
    const endpoint = worker.replace(/\/+$/,"")+"/api/parseWeek?u="+encodeURIComponent(weekUrl);
    const resp = await fetch(endpoint);
    if(!resp.ok){ throw new Error("parseWeek "+resp.status); }
    const data = await resp.json(); // { ok:true, weekTitle, song, sections }
    if(!data.ok){ throw new Error("parseWeek body"); }
    const result = { source: weekUrl, song: data.song, sections: data.sections, weekTitle: data.weekTitle };
    latestSongs = data.song;
    lastResult = result;
    out.textContent = JSON.stringify(result, null, 2);
    render(result);
    btnCopyPreview.style.display=""; btnCopyPreview.setAttribute('aria-label','Copy schedule');
  }catch(e){ console.error(e); weeksStatus.textContent="Parse failed"; }
}

/* ----------------- Render ----------------- */
function render(res){
  const { song: songs, sections } = res;
  const c = $("#weekView");
  c.innerHTML = `<div class="grid" style="grid-template-columns: 1fr;">
    <div class="tile"><h3>SONG</h3>
      <div class="section"><h4>Opening</h4><div class="muted">${songs?.opening ?? "—"}</div></div>
      <div class="section"><h4>Middle</h4><div class="muted">${songs?.middle ?? "—"}</div></div>
      <div class="section"><h4>Closing</h4><div class="muted">${songs?.closing ?? "—"}</div></div>
    </div>
    ${(sections||[]).map(sec => `
      <div class="tile">
        <h3>${escapeHtml(sec.section)}${sec.minutes!=null?` <span class="sec-min">(${sec.minutes} min.)</span>`:""}</h3>
        ${(sec.items||[]).map(it => `
          <div class="section">
            <h4>${it.num}. ${escapeHtml(it.title || "")}</h4>
            ${it.sublabel ? `<div class="muted italic">${escapeHtml(it.sublabel)}</div>` : ``}
            <div class="muted">${it.minutes!=null?`(${it.minutes} min.)`:`(min. not listed)`}</div>
          </div>
        `).join("")}
      </div>
    `).join("")}
  </div>`;
}

/* ----------------- Utils ----------------- */
async function copyText(text){
  try{
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(e){}
  try{
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px'; ta.style.top = '0';
    document.body.appendChild(ta); ta.focus(); ta.select();
    const ok = document.execCommand('copy'); document.body.removeChild(ta); return ok;
  }catch(e){ return false; }
}

function buildScheduleText(weekTitle, res){
  const lines = [];
  lines.push(weekTitle || res.weekTitle || "Week", "");
  if(res.song){
    lines.push("SONG");
    lines.push(`Opening: ${res.song.opening ?? "—"}`);
    lines.push(`Middle: ${res.song.middle ?? "—"}`);
    lines.push(`Closing: ${res.song.closing ?? "—"}`, "");
  }
  for(const sec of res.sections||[]){
    const head = sec.minutes!=null ? `${sec.section} (${sec.minutes} min.)` : sec.section;
    lines.push(head);
    for(const it of sec.items||[]){
      const sbl = it.sublabel ? ` — ${it.sublabel}` : "";
      const mins = it.minutes!=null ? ` (${it.minutes} min.)` : " (min. not listed)";
      lines.push(`${it.num}. ${it.title}${sbl}${mins}`);
    }
    lines.push("");
  }
  return lines.join("\n").replace(/\n{3,}/g,"\n\n").trim();
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
</script>
</body>
</html>
        <div class="strip"></div>
        <div class="controls">
          <div>
            <label>Cloudflare Worker base URL</label>
            <input type="text" id="workerBase" value="https://lmm-tues.latnem.workers.dev/" />
            <div class="btns">
              <button class="warn" id="btnTestWorker">Test</button>
              <span class="status" id="workerStatus"></span>
            </div>
          </div>
          <div>
            <label>LMM Workbook URL</label>
            <input type="url" id="mainUrl" value="https://www.jw.org/ase/library/jw-meeting-workbook/" />
            <div class="btns">
              <button class="primary" id="btnLoadMonths">Load</button>
              <span class="status" id="monthsStatus"></span>
            </div>
            <div class="grid" id="monthsGrid"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="strip"></div>
        <h3>Output</h3>
        <div class="grid" id="weeksGrid" style="margin-bottom:8px;"></div>
        <div class="btns" style="margin-bottom:8px">
          <button class="ghost" id="btnCopyAll">JSON</button>
          <button class="ghost" id="btnClear">Clear</button>
          <span class="status" id="weeksStatus"></span>
        </div>
        <pre class="mono" id="out" style="min-height:160px;"></pre>
      </div>
    </div>

    <div class="card" id="detail" style="display:none">
      <div class="strip"></div>
      <div class="week-head">
        <h3 id="weekTitle">Week</h3>
        <button class="iconbtn" id="btnCopyPreview" title="Copy schedule" style="display:none"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2m2-2h4a2 2 0 012 2v0a2 2 0 01-2 2h-4a2 2 0 01-2-2v0a2 2 0 012-2z"/></svg></button>
      </div>
      <div id="weekView"></div>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const monthsGrid=$("#monthsGrid"), weeksGrid=$("#weeksGrid");
const monthsStatus=$("#monthsStatus"), weeksStatus=$("#weeksStatus"), workerStatus=$("#workerStatus");
const out=$("#out"), weekView=$("#weekView"), btnBack=$("#btnBack");
const btnCopyPreview = $("#btnCopyPreview");

let latestSongs=null, lastResult=null;

$("#btnClear").onclick=()=>{ out.textContent=""; weekView.innerHTML=""; weeksStatus.textContent=""; latestSongs=null; lastResult=null; btnCopyPreview.style.display="none"; };
$("#btnCopyAll").onclick=async()=>{
  if(!latestSongs && !out.textContent){ weeksStatus.textContent="Nothing to copy."; return; }
  const songsTxt = latestSongs ? `Opening: ${latestSongs.opening||"—"}\nMiddle: ${latestSongs.middle||"—"}\nClosing: ${latestSongs.closing||"—"}\n\n` : "";
  const txt = songsTxt + (out.textContent||"");
  try{ await navigator.clipboard.writeText(txt); weeksStatus.textContent="Copied JSON."; }catch{ weeksStatus.textContent="Copy failed."; }
};
btnCopyPreview.addEventListener('click', async (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  const wtEl = document.querySelector('#weekTitle');
  const wt = wtEl ? wtEl.textContent : 'Week';
  const res = lastResult;
  if(!res){ weeksStatus.textContent='Nothing parsed yet.'; return; }
  const text = buildScheduleText(wt, res);
  const ok = await copyText(text);
  weeksStatus.textContent = ok ? 'Copied schedule.' : 'Copy failed.';
});

btnBack.onclick=()=>{ $("#detail").style.display="none"; $("#front").style.display=""; btnBack.style.display="none"; };

// --- Test worker ---
$("#btnTestWorker").onclick=async()=>{
  const worker=$("#workerBase").value.trim();
  if(!worker){ workerStatus.textContent="Enter Worker URL"; return; }
  workerStatus.textContent="Pinging…";
  try{
    const pingUrl = worker.replace(/\/+$/,"")+"/api/ping";
    const res = await fetch(pingUrl, {method:"GET"});
    await res.text();
    workerStatus.textContent = res.ok? "Ping OK ("+res.status+")" : "Ping failed ("+res.status+")";
  }catch(e){ workerStatus.textContent = "Ping error"; }
};

// --- Load months ---
$("#btnLoadMonths").onclick=async()=>{
  const worker=$("#workerBase").value.trim(), main=$("#mainUrl").value.trim();
  if(!worker||!main){ monthsStatus.textContent="Missing input"; return; }
  monthsStatus.textContent="Loading month…"; monthsGrid.innerHTML=""; weeksGrid.innerHTML=""; weeksStatus.textContent="";
  try{
    const endpoint = worker.replace(/\/+$/,"")+"/api/fetch?u="+encodeURIComponent(main);
    const resp = await fetch(endpoint);
    if(!resp.ok){ throw new Error("Fetch "+resp.status); }
    const html = await resp.text();
    const doc=new DOMParser().parseFromString(html,"text/html");
    let items = extractMonthLinks(doc, main);
    items = items.filter(it=>!isPastMonthByTitle(it.title));
    if(!items.length){ monthsStatus.textContent="No months found"; return; }
    items.sort((a,b)=>monthStartFromTitle(a.title)-monthStartFromTitle(b.title));
    monthsStatus.textContent = items.length+" months found";
    renderMonths(items);
  }catch(e){ monthsStatus.textContent="Load failed"; }
};

function isPastMonthByTitle(title){
  const parsed = parseMonthRangeTitle(title);
  if(!parsed) return false;
  const { endYear, endMonthIndex } = parsed;
  const end = new Date(endYear, endMonthIndex + 1, 0);
  const now = new Date();
  const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  return end < startOfThisMonth;
}

function parseMonthRangeTitle(title){
  const months = {january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11};
  if(!title) return null;
  const t = String(title).toLowerCase().trim();
  const re = /([a-z]+)\s*[–-]\s*([a-z]+)\s+(\d{4})/i;
  const m = t.match(re);
  if(!m) return null;
  const m1 = months[m[1]], m2 = months[m[2]], year = parseInt(m[3],10);
  if(m1==null || m2==null || !year) return null;
  return { startMonthIndex: m1, endMonthIndex: m2, startYear: year, endYear: year };
}

function monthStartFromTitle(title){
  const parsed = parseMonthRangeTitle(title);
  if(!parsed) return new Date(8640000000000000);
  return new Date(parsed.startYear, parsed.startMonthIndex, 1);
}

function extractMonthLinks(doc, baseUrl){
  const as = Array.from(doc.querySelectorAll("a")); const items = [];
  for(const a of as){
    const href = a.getAttribute("href"); if(!href) continue;
    let url; try{ url=new URL(href, baseUrl).href; }catch{ continue; }
    if (/\/jw-meeting-workbook\/[^\/]*-mwb\/?$/i.test(url) || (/-mwb\/?$/i.test(url) && /\/jw-meeting-workbook\//i.test(url))) {
      let title=(a.textContent||"").trim();
      if(!title || !parseMonthRangeTitle(title)){
        const slug = url.replace(/\/+$/,"").split("/").pop() || "";
        const t = slug.replace(/-mwb$/i,"").replace(/-/g," ").replace(/\b(\w)/g, s=>s.toUpperCase());
        title = t.replace(/\b(September|October|November|December|January|February|March|April|May|June|July|August)\s+(?=(January|February|March|April|May|June|July|August|September|October|November|December)\b)/, "$1–");
      }
      if(title && url && !items.some(x=>x.href===url)) items.push({title, href:url});
    }
  }
  return items;
}

function renderMonths(items){
  monthsGrid.innerHTML="";
  for(const it of items){
    const tile=document.createElement("div");
    tile.className="tile";
    tile.innerHTML=`<h3>${escapeHtml(it.title)}</h3><div class="btns"><button class="teal">Open</button></div>`;
    tile.querySelector("button").onclick=()=>loadWeeks(it.href, it.title);
    monthsGrid.appendChild(tile);
  }
}

async function loadWeeks(monthUrl, title){
  weeksStatus.textContent=`Loading week…`; weeksGrid.innerHTML="";
  try{
    const worker=$("#workerBase").value.trim();
    const html=await fetch(worker.replace(/\/+$/,"")+"/api/fetch?u="+encodeURIComponent(monthUrl)).then(r=>r.text());
    const doc=new DOMParser().parseFromString(html,"text/html");
    const items=extractWeekLinks(doc, monthUrl);
    if(!items.length){ weeksStatus.textContent="No weeks found"; return; }
    items.sort((a,b)=>weekStartFromUrl(a.href)-weekStartFromUrl(b.href));
    weeksStatus.textContent = items.length+" weeks found";
    renderWeeks(items);
  }catch(e){ weeksStatus.textContent="Load failed"; }
}

function weekStartFromUrl(url){
  try{
    const u = new URL(url);
    const slug = decodeURIComponent(u.pathname.replace(/\/+$/,"").split("/").pop());
    const re = /for-([A-Za-z]+)-(\d{1,2})(?:-([A-Za-z]+))?-(\d{1,2})-(\d{4})$/i;
    const m = slug.match(re);
    if(!m) return new Date(8640000000000000);
    const months = {january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11};
    const mi = months[m[1].toLowerCase()] ?? 0;
    const d1 = parseInt(m[2],10);
    const y  = parseInt(m[5],10);
    return new Date(y, mi, d1);
  }catch{ return new Date(8640000000000000); }
}

function extractWeekLinks(doc, baseUrl){
  const candidates=[];
  const as=Array.from(doc.querySelectorAll("a"));
  for(const a of as){
    const href=a.getAttribute("href"); if(!href) continue;
    let url; try{ url=new URL(href, baseUrl).href; }catch{ continue; }
    const text=(a.textContent||"").trim();
    if(/Life-and-Ministry-Meeting-Schedule/i.test(url) || /Life-and-Ministry-Meeting-Schedule/i.test(text)){
      const title = formatWeekFromUrl(url, text || "Week");
      candidates.push({title, href:url});
    }
  }
  const uniq=[]; const out=[];
  for(const c of candidates){ if(!uniq.includes(c.href)){ uniq.push(c.href); out.push(c);} }
  return out;
}

function renderWeeks(items){
  weeksGrid.innerHTML="";
  for(const it of items){
    const tile=document.createElement("div");
    tile.className="tile";
    tile.innerHTML=`<h3>${escapeHtml(it.title)}</h3>
    <div class="btns"><button class="emerald">Parse</button></div>`;
    tile.querySelector("button").onclick=()=>parseWeek(it.href, it.title);
    weeksGrid.appendChild(tile);
  }
}

async function parseWeek(weekUrl, weekLabel){
  weeksStatus.textContent="Loading week…";
  out.textContent=""; weekView.innerHTML=""; latestSongs=null; lastResult=null;
  const wt=document.querySelector('#weekTitle'); if(wt) wt.textContent = weekLabel || 'Week';
  try{
    const worker=$("#workerBase").value.trim();
    const html=await fetch(worker.replace(/\/+$/,"")+"/api/fetch?u="+encodeURIComponent(weekUrl)).then(r=>{
      if(!r.ok) throw new Error("Fetch "+r.status); return r.text();
    });
    const doc=new DOMParser().parseFromString(html,"text/html");
    const text=(doc.body.innerText||"").replace(/\u00A0/g," ");
    const songs=extractSongsStrict(text);
    latestSongs=songs;
    const sections=extractSectionsWithSectionMinutes(doc);
    const result={source:weekUrl,song:songs,sections};
    out.textContent=JSON.stringify(result,null,2);
    render(result);
    lastResult=result;
    // Show copy icon once we have content
    btnCopyPreview.style.display=""; btnCopyPreview.setAttribute('aria-label','Copy schedule');

    // Silent-save to Worker KV
    try{
      const workerBase = $("#workerBase").value.trim().replace(/\/+$/,"");
      await fetch(workerBase + "/api/playlist/upsert", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ weekLabel: weekLabel || formatWeekFromUrl(weekUrl, "Week"), sourceUrl: weekUrl, data: result })
      });
      weeksStatus.textContent = (weeksStatus.textContent ? weeksStatus.textContent + " · " : "") + "Saved";
    }catch{ /* ignore */ }

  }catch(e){ weeksStatus.textContent="Parse failed"; }
}

function extractSongsStrict(allText){
  const lines=allText.split(/\n+/);const uniq=[];
  for(const l of lines){const m=l.match(/\bSong\b[^0-9]{0,10}(\d{1,3})\b/i);if(m&&!uniq.includes(m[1]))uniq.push(m[1]);}
  return{opening:uniq[0]||null,middle:uniq[1]||null,closing:uniq[2]||null};
}

function extractSectionsWithSectionMinutes(doc){
  const secNames=["TREASURES FROM GOD’S WORD","APPLY YOURSELF TO THE FIELD MINISTRY","LIVING AS CHRISTIANS"];
  const raw=(doc.body.innerText||"").replace(/\u00A0/g," ");
  const lines=raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);

  const secs=[];
  const isItemStart = (s)=>/^\s*[0-9]+\.\s+/.test(s);
  const isMinutesOnlyLine = (s)=>/\b\d+\s*min\.?\b/i.test(s);
  const findMinutes = (s)=>{ const m = s.match(/\(?\s*(\d+)\s*min\.?\s*\)?/i); return m? +m[1] : null; };
  const isHeader = (s)=>secNames.some(h=>norm(s).startsWith(norm(h)));
  const isStopper = (s)=>/^Concluding Comments/i.test(s)||/^Prayer/i.test(s)||isHeader(s);

  function scan(start){
    const arr=[];
    for(let i=start;i<lines.length;i++){
      const l=lines[i];
      if(isStopper(l)) break;

      let m = l.match(/^\s*([0-9]+)\.\s*(.+?)\s*$/);
      if(m){
        const num = +m[1];
        let title = m[2].trim();
        let minutes = findMinutes(title);
        if(minutes!=null){
          title = title.replace(/\s*\(?\s*\d+\s*min\.?\s*\)?\s*$/i, "").trim();
        }else{
          let consumed = 0;
          for(let j=i+1;j<lines.length && j<=i+2;j++){
            const ln = lines[j];
            if(isStopper(ln) || isItemStart(ln)) break;
            if(isMinutesOnlyLine(ln)){
              minutes = findMinutes(ln);
              consumed = j - i;
              break;
            }
          }
          if(consumed>0) i += consumed;
        }
        arr.push({num, title, minutes});
      }
    }
    return arr;
  }

  for(const name of secNames){
    const idx = lines.findIndex(t=>norm(t).startsWith(norm(name)));
    if(idx>=0){
      const headerLine = lines[idx];
      const headerMinutes = findMinutes(headerLine);
      secs.push({section:name, minutes: headerMinutes, items: scan(idx+1)});
    }else{
      secs.push({section:name, minutes:null, items:[]});
    }
  }
  return secs;
}

function norm(s){return (s||"").toLowerCase().replace(/\s+/g," ");}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function formatWeekFromUrl(url, fallbackText){
  try{
    const u = new URL(url);
    const slug = decodeURIComponent(u.pathname.replace(/\/+$/,"").split("/").pop());
    const re = /for-([A-Za-z]+)-(\d{1,2})(?:-([A-Za-z]+))?-(\d{1,2})-(\d{4})$/i;
    const m = slug.match(re);
    if(!m) return fallbackText || "Week";
    const cap = s => s.slice(0,1).toUpperCase()+s.slice(1).toLowerCase();
    const m1 = cap(m[1]), d1 = parseInt(m[2],10);
    const m2 = m[3] ? cap(m[3]) : m1;
    const d2 = parseInt(m[4],10);
    const y  = parseInt(m[5],10);
    const dash = "–";
    const label = (m2===m1) ? `${m1} ${d1}${dash}${d2}, ${y}` : `${m1} ${d1}${dash}${m2} ${d2}, ${y}`;
    return label;
  }catch{ return fallbackText || "Week"; }
}

function render(res){
  const{song: songs,sections}=res;
  const c=$("#weekView");
  // one tile per row
  c.innerHTML=`<div class="grid" style="grid-template-columns: 1fr;">
    <div class="tile"><h3>SONG</h3>
      <div class="section"><h4>Opening</h4><div class="muted">${songs?.opening??"—"}</div></div>
      <div class="section"><h4>Middle</h4><div class="muted">${songs?.middle??"—"}</div></div>
      <div class="section"><h4>Closing</h4><div class="muted">${songs?.closing??"—"}</div></div>
    </div>
    ${sections.map(sec=>`
      <div class="tile">
        <h3>${sec.section}${sec.minutes!=null?` <span class="sec-min">(${sec.minutes} min.)</span>`:""}</h3>
        ${Array.isArray(sec.items)&&sec.items.length?sec.items.map(it=>`
          <div class="section"><h4>${it.num}. ${it.title}</h4><div class="muted">${it.minutes!=null?`(${it.minutes} min.)`:`(min. not listed)`}</div></div>
        `).join(""):""}
      </div>
    `).join("")}
  </div>`;
  $("#detail").style.display=""; $("#front").style.display=""; // keep both visible
}


async function copyText(text){
  // Try modern API first
  try{
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(e){ /* fall through to legacy */ }
  // Legacy fallback: hidden textarea + execCommand
  try{
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  }catch(e){ return false; }
}

// Build a human-readable schedule for clipboard
function buildScheduleText(weekTitle, res){
  const lines = [];
  lines.push(weekTitle);
  lines.push("");
  if(res.song){
    lines.push("SONG");
    lines.push(`Opening: ${res.song.opening ?? "—"}`);
    lines.push(`Middle: ${res.song.middle ?? "—"}`);
    lines.push(`Closing: ${res.song.closing ?? "—"}`);
    lines.push("");
  }
  for(const sec of res.sections||[]){
    const head = sec.minutes!=null ? `${sec.section} (${sec.minutes} min.)` : sec.section;
    lines.push(head);
    for(const it of sec.items||[]){
      const mins = it.minutes!=null ? ` (${it.minutes} min.)` : " (min. not listed)";
      lines.push(`${it.num}. ${it.title}${mins}`);
    }
    lines.push("");
  }
  return lines.join("\n").replace(/\n{3,}/g,"\n\n").trim();
}
</script>
</body>
</html>
